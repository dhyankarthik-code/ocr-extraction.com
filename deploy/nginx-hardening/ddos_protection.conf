# /etc/nginx/conf.d/ddos_protection.conf

# 1. Limit Request Rate (Mitigate HTTP Floods)
# Limit to 10 requests per second per IP for general API
limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;
# Limit to 1 request per second for login/expensive pages
limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;

# 2. Limit Connections (Mitigate Slowloris)
# Limit to 10 concurrent connections per IP
limit_conn_zone $binary_remote_addr zone=addr:10m;

server {
    # Apply Limits
    limit_conn addr 10;
    
    # Global Rate Limit
    limit_req zone=one burst=20 nodelay;

    # Timeouts to cut dead connections (Slowloris defense)
    client_body_timeout 10s;
    client_header_timeout 10s;
    keepalive_timeout 15s;
    send_timeout 10s;

    # Buffer Limits (prevent buffer overflow attacks)
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    client_max_body_size 10M; # Adjust as needed for PDF uploads
    large_client_header_buffers 4 4k;
}
